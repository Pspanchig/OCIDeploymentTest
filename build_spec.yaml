version: 0.1
component: build
timeoutInSeconds: 1800
runAs: root
shell: bash

env:
  variables:
    NODE_MAJOR: "20"
    BUCKET_NAME: "my-react-site"

steps:
  - name: Métricas iniciales (CPU/RAM/Disco)
    type: Command
    command: |
      set -euo pipefail
      echo "=== METRICAS INICIALES ==="
      echo "CPUs: $(nproc)"
      echo "Memoria (MB):"; free -m || true
      echo "Disco:"; df -h || true
      echo "Top snapshot:"; top -b -n 1 | head -n 20 || true

- name: Instalar Node.js
    type: Command
    command: |
      set -euo pipefail
      echo "Installing Node.js ${NODE_MAJOR}..."
      # Add NodeSource repo for RHEL/Oracle-Linux family
      curl -fsSL "https://rpm.nodesource.com/setup_${NODE_MAJOR}.x" | bash -
      # Pick whichever package manager exists on the runner
      if command -v dnf >/dev/null 2>&1; then
        dnf install -y nodejs
      elif command -v yum >/dev/null 2>&1; then
        yum install -y nodejs
      elif command -v microdnf >/dev/null 2>&1; then
        microdnf install -y nodejs
      else
        echo "No supported package manager found (dnf/yum/microdnf)"; exit 1
      fi
      node -v && npm -v

  - name: Instalar dependencias
    type: Command
    command: |
      set -euo pipefail
      if [ -f package-lock.json ]; then npm ci; else npm install; fi

  - name: Compilar aplicación
    type: Command
    command: |
      set -euo pipefail
      npm run build

  - name: Métricas post-build
    type: Command
    command: |
      set -euo pipefail
      echo "=== METRICAS POST-BUILD ==="
      free -m || true
      df -h || true

  - name: Subir a Object Storage
    type: Command
    command: |
      set -euo pipefail
      export OCI_CLI_AUTH=resource_principal
      oci os object bulk-delete -bn "${BUCKET_NAME}" --force --quiet || true
      oci os object bulk-upload \
        -bn "${BUCKET_NAME}" \
        --src-dir build \
        --overwrite \
        --content-type auto \
        --verify-checksum
      echo "✅ Upload completed to bucket ${BUCKET_NAME}"

